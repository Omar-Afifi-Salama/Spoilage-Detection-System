<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #e9f7fd, #f4faff);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      text-align: center;
    }

    .loading-indicator {
      font-size: 1.5em;
      font-weight: bold;
      color: #007BFF;
      margin: 20px 0;
    }

    .dashboard {
      text-align: center;
      padding: 20px;
      width: 100%;
    }

    .section {
      width: 90%;
      max-width: 1200px;
      background-color: #f0f0f0;
      border-radius: 10px;
      padding: 20px;
      margin: 0 auto 30px; /* Center horizontally and add bottom margin */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }


    .section-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }

    .parameters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .parameter-block {
      background: #ffffff;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 20px;
      width: 200px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .parameter-block:hover {
      transform: translateY(-10px);
      box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.2);
    }

    .parameter-block h2 {
      font-size: 1.5em;
      margin: 10px 0;
    }

    .parameter-block .value {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .parameter-block .status {
      font-size: 1em;
      font-weight: bold;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
    }

    .parameter-block .status.normal {
      background-color: #28a745;
    }

    .parameter-block .status.dangerous {
      background-color: #dc3545;
    }

    .charts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
    }

    .chart-block {
      width: 45%;
      padding: 10px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .chart-block:hover {
      transform: translateY(-10px);
      box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.2);
    }

    button {
      margin-top: 30px;
      padding: 12px 24px;
      background-color: #007BFF;
      color: #ffffff;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
      box-shadow: 0px 6px 10px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    button:active {
      background-color: #004080;
      transform: translateY(0);
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }

    #current-time {
      font-size: 24px; /* Larger text for better readability */
      color: #000000; /* White text for contrast */
      margin-top: 10px;
      font-family: 'Roboto', sans-serif; /* More modern font */
      text-align: center;
      background-color: #f0f0f0;
      padding: 10px 20px;
      border-radius: 12px; /* Rounded corners */
      box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transition */
      font-weight: bold;
    }

    #current-time:hover {
      transform: scale(1.05); /* Slightly enlarge the time on hover */
      box-shadow: 2px 2px 20px rgba(0, 0, 0, 0.2); /* Slightly darker shadow on hover */
    }

    #header h1 {
      font-size: 36px;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      text-align: center;
      color: #333; /* Darker color for the header */
    }

    .block-container {
      background-color: #f0f0f0;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional shadow */
      display: inline-block;
      margin-bottom: 10px;
      width: 50%; /* Make the block full width */
    }

    #dashboard-header h1 {
      margin: 0;
      font-size: 24px;
      align-items: center; /* Center-align the content */
    }

  </style>
</head>

<body>

  <div id="dashboard-header" class="block-container">
    <h1>Dashboard</h1>
    <div id="current-time"></div>
  </div>

  <div id="loading" class="loading-indicator">Loading data...</div>

  <div class="dashboard">
    <!-- Data Section -->
    <div class="section">
      <div class="section-title">Data</div>
      <div id="parameters" class="parameters"></div>
    </div>
  
    <!-- Graphs Section -->
    <div class="section">
      <div class="section-title">Graphs</div>
      <div id="charts-container" class="charts-container"></div>
    </div>
  </div>  

  <button id="download-btn" disabled>Download CSV</button>

  <script>

  function updateTime() {
    const timeElement = document.getElementById('current-time');
    
    const currentDate = new Date();
    let hours = currentDate.getHours();
    const minutes = currentDate.getMinutes().toString().padStart(2, '0');
    const seconds = currentDate.getSeconds().toString().padStart(2, '0');
    
    // Determine AM or PM
    const period = hours >= 12 ? 'PM' : 'AM';

    // Convert hours to 12-hour format
    hours = hours % 12 || 12; // Convert "0" to "12" for midnight
    
    // Format the time as HH:mm:ss AM/PM
    const formattedTime = `${hours.toString().padStart(2, '0')} : ${minutes} : ${seconds} ${period}`;

    // Update the time on the webpage
    timeElement.textContent = formattedTime;
  }

    // Call updateTime every second
    setInterval(updateTime, 1000);

    // Update the time every second
    setInterval(updateTime, 1000);

    // Call once to set the initial time immediately
    updateTime();

    const APP_ID = '43587D63-E5C5-4966-844B-E75C72804CCC';
    const API_KEY = '7F3F9B1E-2DA2-467E-80DA-D5126E9EE8C8';
    const TABLE_NAME = 'SensorData2';

    const safeRanges = {
      Temperature: { min: 0, max: 5, unit: 'Â°C' },
      Humidity: { min: 70, max: 90, unit: '%' },
      CO2: { min: 0, max: 1000, unit: 'ppm' },
      CH4: { min: 0, max: 10, unit: 'ppm' },
      NH3: { min: 0, max: 5, unit: 'ppm' },
      Propane: { min: 0, max: 2, unit: 'ppm' },
      Toluene: { min: 0, max: 1, unit: 'ppm' },
      Alcohol: { min: 0, max: 50, unit: 'ppm' },
    };

    // Fetch the latest data (for dashboard)
    async function fetchLatestData() {
      const response = await fetch(
        `https://api.backendless.com/${APP_ID}/${API_KEY}/data/${TABLE_NAME}?pageSize=1&sortBy=created desc`
      );
      const [latestData] = await response.json(); // Get the most recent row
      return latestData;
    }

    // Fetch all data (for CSV and charts)
    async function fetchAllData() {
      const pageSize = 100;
      let offset = 0;
      let allData = [];
      let dataChunk;

      try {
        do {
          const response = await fetch(
            `https://api.backendless.com/${APP_ID}/${API_KEY}/data/${TABLE_NAME}?pageSize=${pageSize}&offset=${offset}`
          );
          dataChunk = await response.json();
          allData = allData.concat(dataChunk);
          offset += pageSize;
        } while (dataChunk.length === pageSize);

        // Sort data by timestamp (assuming "created" is the timestamp field)
        allData.sort((a, b) => new Date(a.created) - new Date(b.created));

        return allData;
      } catch (error) {
        console.error('Error fetching data:', error);
        return [];
      }
    }

    // Convert JSON to CSV
    function jsonToCsv(data) {
      if (!data || data.length === 0) return '';

      const headers = Object.keys(data[0]);
      const rows = data.map(row =>
        headers.map(header => `"${row[header] || ''}"`).join(',')
      );
      return [headers.join(','), ...rows].join('\n');
    }

    // Trigger CSV download
    function downloadCsv(csvContent, filename = 'data.csv') {
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Create a chart
    function createChart(canvasId, label, data, labels, color) {
      const slicedLabels = labels.slice(-100); // Last 100 sorted timestamps
      const slicedData = data.slice(-100); // Last 100 sorted data points

      new Chart(document.getElementById(canvasId), {
        type: 'line',
        data: {
          labels: slicedLabels,
          datasets: [
            {
              label: label,
              data: slicedData,
              borderColor: color,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'Time (HH:mm:ss)' } },
            y: { title: { display: true, text: label } },
          },
        },
      });
    }

    // Check if the value is within the safe range
    function checkSafety(value, range) {
      return value >= range.min && value <= range.max ? 'Normal' : 'Dangerous';
    }

    // Create a dashboard with the latest data
    function createDashboard(latestData) {
      const parameterContainer = document.getElementById('parameters');
      parameterContainer.innerHTML = ''; // Clear existing content

      Object.entries(safeRanges).forEach(([key, range]) => {
        const value = latestData[key];

        // Skip creating a parameter block if value is missing
        if (value === undefined || value === null) return;

        const status = checkSafety(value, range);

        const block = document.createElement('div');
        block.className = 'parameter-block';
        block.innerHTML = `
          <h2>${key}</h2>
          <div class="value">${value} ${range.unit}</div>
          <div class="status ${status.toLowerCase()}">${status}</div>
        `;
        parameterContainer.appendChild(block);
      });
    }

    // Initialize the dashboard and charts
    async function initialize() {
      const allData = await fetchAllData();

      // Hide loading indicator
      document.getElementById('loading').style.display = 'none';

      // Map sorted data to labels and chart data
      const labels = allData.map(item => new Date(item.created).toLocaleTimeString());
      const chartsContainer = document.getElementById('charts-container');
      chartsContainer.innerHTML = ''; // Clear existing content

      const colors = [
        'rgba(255, 99, 132, 1)', // Red
        'rgba(54, 162, 235, 1)', // Blue
        'rgba(75, 192, 192, 1)', // Green
        'rgba(255, 206, 86, 1)', // Yellow
        'rgba(153, 102, 255, 1)', // Purple
        'rgba(255, 159, 64, 1)', // Orange
        'rgba(201, 203, 207, 1)', // Gray
        'rgba(100, 149, 237, 1)', // Cornflower Blue
      ];

      Object.entries(safeRanges).forEach(([key, range], index) => {
        const chartData = allData.map(item => item[key]).filter(value => value !== undefined);

        // Skip creating a chart if no data exists for this key
        if (chartData.length === 0) return;

        const canvasId = `${key}-chart`;
        const chartBlock = document.createElement('div');
        chartBlock.className = 'chart-block';
        chartBlock.innerHTML = `<canvas id="${canvasId}"></canvas>`;
        chartsContainer.appendChild(chartBlock);

        const color = colors[index % colors.length]; // Cycle through colors
        createChart(canvasId, `${key} (${range.unit})`, chartData, labels, color);
      });

      if (allData.length > 0) {
        // Show the latest data in the dashboard
        createDashboard(allData[allData.length - 1]);

        // Enable CSV download
        const csvContent = jsonToCsv(allData);
        const downloadButton = document.getElementById('download-btn');
        downloadButton.disabled = false;
        downloadButton.addEventListener('click', () => downloadCsv(csvContent));
      }
    }

    // Initialize the app
    initialize();

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>